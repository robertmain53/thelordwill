generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}


model Book {
  id           Int      @id
  name         String   @unique
  slug         String   @unique
  testament    String
  genre        String
  chapters     Int
  verses       Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  verseRecords Verse[]

  @@index([testament])
  @@index([genre])
  @@index([slug])
}

model Verse {
  id                  Int                       @id
  bookId              Int
  chapter             Int
  verseNumber         Int
  textKjv             String?
  textWeb             String?
  textAsv             String?
  textBbe             String?
  textYlt             String?
  wordsCount          Int?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  textBL              String?
  textRV              String?
  namesFirstMentioned Name[]                    @relation("FirstMention")
  nameMentions        NameMention[]
  placeMentions       PlaceVerseMapping[]
  prayerPointMappings PrayerPointVerseMapping[]
  situationMappings   SituationVerseMapping[]
  book                Book                      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  strongsNumbers      VerseStrong[]
  embedding           VerseEmbedding?

  @@unique([bookId, chapter, verseNumber])
  @@index([bookId, chapter])
  @@index([bookId])
  @@index([chapter])
}

model StrongsLexicon {
  strongsId       String        @id
  originalWord    String
  transliteration String
  definition      String
  language        String
  occurrences     Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  verseUsages     VerseStrong[]

  @@index([language])
  @@index([occurrences])
}

model VerseStrong {
  id        String         @id @default(cuid())
  verseId   Int
  strongsId String
  position  Int?
  strongs   StrongsLexicon @relation(fields: [strongsId], references: [strongsId], onDelete: Cascade)
  verse     Verse          @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@unique([verseId, strongsId, position])
  @@index([verseId])
  @@index([strongsId])
}

model Name {
  id                   String         @id @default(cuid())
  name                 String         @unique
  slug                 String         @unique
  meaning              String
  originLanguage       String
  characterDescription String
  firstMentionVerseId  Int?
  metaTitle            String?
  metaDescription      String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  firstMentionVerse    Verse?         @relation("FirstMention", fields: [firstMentionVerseId], references: [id])
  mentions             NameMention[]
  relatedNames         NameRelation[] @relation("NameRelations")

  @@index([slug])
  @@index([name])
  @@index([originLanguage])
}

model NameMention {
  id      String  @id @default(cuid())
  nameId  String
  verseId Int
  context String?
  name    Name    @relation(fields: [nameId], references: [id], onDelete: Cascade)
  verse   Verse   @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@unique([nameId, verseId])
  @@index([nameId])
  @@index([verseId])
}

model NameRelation {
  id               String @id @default(cuid())
  nameId           String
  relatedNameId    String
  relationshipType String
  name             Name   @relation("NameRelations", fields: [nameId], references: [id], onDelete: Cascade)

  @@unique([nameId, relatedNameId])
  @@index([nameId])
}

model Situation {
  id              String  @id @default(cuid())
  slug            String  @unique
  title           String  @unique
  metaDescription String  @db.Text
  content         String? @db.Text
  titleTranslations Json?
  metaDescriptionTranslations Json? @db.Text
  contentTranslations Json? @db.Text
  category        String?

  // Publish state
  status      String    @default("draft") // "draft" | "published"
  publishedAt DateTime?

  verseMappings     SituationVerseMapping[]
  relatedSituations SituationRelation[]     @relation("SituationRelations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([title])
  @@index([category])
  @@index([status])
  @@index([status, category])
  @@index([status, publishedAt])
}

model SituationVerseMapping {
  id             String    @id @default(cuid())
  situationId    String
  verseId        Int
  relevanceScore Int       @default(50)
  manualNote     String?
  isVerified     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  situation      Situation @relation(fields: [situationId], references: [id], onDelete: Cascade)
  verse          Verse     @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@unique([situationId, verseId])
  @@index([situationId, relevanceScore])
  @@index([verseId])
  @@index([relevanceScore])
}

model SituationRelation {
  id                 String    @id @default(cuid())
  situationId        String
  relatedSituationId String
  situation          Situation @relation("SituationRelations", fields: [situationId], references: [id], onDelete: Cascade)

  @@unique([situationId, relatedSituationId])
  @@index([situationId])
}

model Profession {
  id              String  @id @default(cuid())
  slug            String  @unique
  title           String  @unique
  description     String  @db.Text
  content         String? @db.Text
  metaTitle       String?
  metaDescription String?
  titleTranslations Json?
  descriptionTranslations Json? @db.Text
  contentTranslations Json? @db.Text
  metaTitleTranslations Json?
  metaDescriptionTranslations Json? @db.Text

  // Publish state
  status      String    @default("draft") // "draft" | "published"
  publishedAt DateTime?

  relatedProfessions ProfessionRelation[] @relation("ProfessionRelations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([title])
  @@index([status])
  @@index([status, publishedAt])
}

model ProfessionRelation {
  id                  String     @id @default(cuid())
  professionId        String
  relatedProfessionId String
  profession          Profession @relation("ProfessionRelations", fields: [professionId], references: [id], onDelete: Cascade)

  @@unique([professionId, relatedProfessionId])
  @@index([professionId])
}

model PrayerPoint {
  id              String  @id @default(cuid())
  slug            String  @unique
  title           String
  description     String  @db.Text
  content         String? @db.Text
  metaTitle       String?
  metaDescription String? @db.Text
  category        String?
  priority        Int     @default(50)
  dailyRotation   Boolean @default(false)

  openingPrayer String? @db.Text
  prayerPoints  Json?

  // Publish state
  status      String    @default("draft") // "draft" | "published"
  publishedAt DateTime?

  // Relations
  verseMappings PrayerPointVerseMapping[]

  // Self-relation edges (OUTGOING and INCOMING)
  relatedPrayerPoints   PrayerPointRelation[] @relation("PrayerPointRelations")
  relatedToPrayerPoints PrayerPointRelation[] @relation("RelatedPrayerPointRelations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([category])
  @@index([priority])
  @@index([dailyRotation])
  @@index([status])
  @@index([status, category])
  @@index([status, publishedAt])
  @@index([status, priority])
}

model PrayerPointVerseMapping {
  id             String      @id @default(cuid())
  prayerPointId  String
  verseId        Int
  relevanceScore Int         @default(50)
  prayerFocus    String?
  contextNote    String?
  isVerified     Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  prayerPoint    PrayerPoint @relation(fields: [prayerPointId], references: [id], onDelete: Cascade)
  verse          Verse       @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@unique([prayerPointId, verseId])
  @@index([prayerPointId, relevanceScore])
  @@index([verseId])
  @@index([relevanceScore])
  @@index([prayerFocus])
}

model PrayerPointRelation {
  id                   String @id @default(cuid())
  prayerPointId        String
  relatedPrayerPointId String

  // OUTGOING edge: PrayerPoint -> relatedPrayerPoint
  prayerPoint PrayerPoint @relation("PrayerPointRelations", fields: [prayerPointId], references: [id], onDelete: Cascade)

  // INCOMING edge counterpart: relatedPrayerPoint <- PrayerPoint
  relatedPrayerPoint PrayerPoint @relation("RelatedPrayerPointRelations", fields: [relatedPrayerPointId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([prayerPointId, relatedPrayerPointId])
  @@index([prayerPointId])
  @@index([relatedPrayerPointId])
}

model DailyPrayerPoint {
  id            String   @id @default(cuid())
  date          DateTime @unique @default(now()) @db.Date
  prayerPointId String
  createdAt     DateTime @default(now())

  @@index([date])
  @@index([prayerPointId])
}

model Place {
  id              String  @id @default(cuid())
  slug            String  @unique
  name            String  @unique
  description     String  @db.Text
  descriptionTranslations Json? @db.Text
  historicalInfo  String? @db.Text
  historicalInfoTranslations Json? @db.Text
  biblicalContext String? @db.Text
  biblicalContextTranslations Json? @db.Text
  modernName      String?
  country         String?
  region          String?
  latitude        Float?
  longitude       Float?
  metaTitle       String?
  metaTitleTranslations Json?
  metaDescription String? @db.Text
  metaDescriptionTranslations Json? @db.Text
  tourHighlight   Boolean @default(false)
  tourPriority    Int     @default(50)

  // Publish state
  status      String    @default("draft") // "draft" | "published"
  publishedAt DateTime?

  // Relationships
  verseMentions   PlaceVerseMapping[]
  relatedPlaces   PlaceRelation[]     @relation("PlaceRelations")
  relatedToPlaces PlaceRelation[]     @relation("RelatedPlace")
  tourLeads       TourLead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([name])
  @@index([country])
  @@index([tourHighlight])
  @@index([tourPriority])
  @@index([status])
  @@index([status, publishedAt])
  @@index([status, tourHighlight])
  @@index([status, country])
}

model PlaceVerseMapping {
  id             String   @id @default(cuid())
  placeId        String
  verseId        Int
  mentionType    String?
  relevanceScore Int      @default(50)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  place          Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  verse          Verse    @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@unique([placeId, verseId])
  @@index([placeId, relevanceScore])
  @@index([verseId])
}

model PlaceRelation {
  id             String  @id @default(cuid())
  placeId        String
  relatedPlaceId String
  relationship   String?
  place          Place   @relation("PlaceRelations", fields: [placeId], references: [id], onDelete: Cascade)
  relatedPlace   Place   @relation("RelatedPlace", fields: [relatedPlaceId], references: [id], onDelete: Cascade)

  @@unique([placeId, relatedPlaceId])
  @@index([placeId])
}

model TourLead {
  id             String    @id @default(cuid())
  name           String
  email          String
  phone          String?
  country        String?
  interestedIn   String[]
  travelDates    String?
  groupSize      Int?
  budget         String?
  sourcePlace    String?
  sourcePage     String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  affiliateId    String?
  commission     Float?
  status         String    @default("new")
  notes          String?
  contactedAt    DateTime?
  bookedAt       DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  contextName    String?
  contextSlug    String?
  contextType    String?
  fbclid         String?
  gclid          String?
  groupSizeRaw   String?
  sourceReferrer String?
  utmContent     String?
  utmTerm        String?
  place          Place?    @relation(fields: [sourcePlace], references: [slug])

  @@index([email])
  @@index([status])
  @@index([sourcePlace])
  @@index([utmSource])
  @@index([utmCampaign])
  @@index([gclid])
  @@index([contextType])
  @@index([contextSlug])
  @@index([createdAt])
  @@index([email, createdAt])
}

model PageView {
  id       String   @id @default(cuid())
  slug     String
  pageType String
  views    Int      @default(0)
  date     DateTime @default(now())

  @@unique([slug, pageType, date])
  @@index([slug])
  @@index([pageType])
  @@index([date])
}

model VersePopularity {
  verseId      Int      @id
  searchCount  Int      @default(0)
  viewCount    Int      @default(0)
  lastAccessed DateTime @default(now())

  @@index([searchCount])
  @@index([viewCount])
}

model IngestionLog {
  id               String    @id @default(cuid())
  source           String
  operation        String
  status           String
  recordsProcessed Int       @default(0)
  recordsFailed    Int       @default(0)
  errorMessage     String?
  startedAt        DateTime  @default(now())
  completedAt      DateTime?

  @@index([source, status])
  @@index([startedAt])
}

model TravelItinerary {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  metaTitle       String?
  metaDescription String?
  days            Int
  region          String
  bestSeason      String?
  whoItsFor       String?
  highlights      String[] @default([])

  content   String?  @db.Text // optional introduction HTML
  // publishing
  status    String   @default("draft") // "draft" | "published"
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  dayPlans TravelItineraryDay[]
  faqs     TravelItineraryFaq[]

  @@index([status])
  @@index([slug])
  @@index([region])
  @@index([status, region])
}

model TravelItineraryDay {
  id          String   @id @default(cuid())
  itineraryId String
  day         Int
  title       String
  places      String[] @default([])
  readings    String[] @default([])
  notes       String?  @db.Text

  itinerary TravelItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  @@unique([itineraryId, day])
  @@index([itineraryId])
}

model TravelItineraryFaq {
  id          String @id @default(cuid())
  itineraryId String
  question    String
  answer      String @db.Text
  order       Int    @default(0)

  itinerary TravelItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  @@index([itineraryId])
}

model TaxonomyLabel {
  id        String   @id @default(cuid())

  // Which content type this label belongs to (future-proof)
  scope     String   // e.g. "prayerPointCategory", "placeRegion", ...

  // Stable key stored in content rows (e.g. PrayerPoint.category)
  key       String

  // Human-facing label shown on the site and in admin
  label     String

  // Optional extra fields if you want later
  sortOrder Int      @default(100)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scope, key])
  @@index([scope])
  @@index([isActive])
}

model VerseEmbedding {
  id          String   @id @default(cuid())
  verseId     Int      @unique
  model       String
  dims        Int
  vector      Json     // stores float[] deterministically as JSON array
  contentHash String   // sha256 of normalized verse text + model name
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  verse Verse @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@index([verseId])
  @@index([model])
  @@index([contentHash])
}
